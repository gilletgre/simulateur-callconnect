<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulateur Call Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --accent: #0ea5e9;
      --accent-strong: #06b6d4;
    }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .tag { font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 999px; }
    .col-product { width: 280px; }
    .col-price { width: 280px; text-align: right; }
    .col-upfront { width: 200px; text-align: right; }
    .col-discount { width: 140px; text-align: right; }
    .col-qte, .col-total, .col-install { width: 200px; text-align: right; }
    .col-install { width: 140px; }
    .row-active { background: linear-gradient(90deg, rgba(14,165,233,0.12), rgba(14,165,233,0)); }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <header class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-8 flex flex-col gap-3">
      <div class="flex items-center gap-3">
        <span class="tag bg-slate-800 text-sky-200 border border-slate-700">PBX vérifié</span>
        <span class="tag bg-emerald-900/60 text-emerald-100 border border-emerald-800">Export prêt Netlify</span>
      </div>
      <div class="flex flex-wrap items-end gap-4">
        <div>
          <h1 class="text-3xl font-bold text-white">Simulateur Call Connect</h1>
          <p class="text-slate-300">Régimes achat / location, remises ciblées et export direct.</p>
        </div>
        <div class="ml-auto text-right space-y-1">
          <p class="text-slate-400 text-sm">Dernière synchro</p>
          <p class="text-xl font-semibold text-white" id="sync-date">-</p>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pb-12 space-y-8">
    <section class="relative overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/80 shadow-2xl shadow-slate-900/60">
      <video autoplay loop muted playsinline class="w-full h-72 object-cover opacity-70">
        <source src="https://www.webex.com/content/dam/wbx/us/images/rebrand/hero-videos/webex_device_landing_hero.mp4" type="video/mp4">
      </video>
      <div class="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/70 to-slate-900/30"></div>
      <div class="absolute inset-0 flex flex-col justify-center px-8 py-6 space-y-3">
        <p class="tag bg-slate-800 text-sky-200 border border-slate-700 w-fit">Vue simulateur</p>
        <h2 class="text-2xl font-bold text-white">Configurez, appliquez les remises, exportez</h2>
      </div>
    </section>

    <section id="offer-summary" class="hidden rounded-2xl border border-slate-800 bg-slate-900/70 shadow-xl shadow-slate-900/50 p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Offre en cours</p>
          <h3 class="text-lg font-semibold text-white">Lignes actives</h3>
        </div>
        <button id="export-offer-top" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow">Exporter l'offre</button>
      </div>
      <div id="offer-list" class="flex flex-wrap gap-3"></div>
    </section>

    <section id="config" class="hidden -mt-8 relative z-10">
      <div class="grid lg:grid-cols-3 gap-6 items-start">
        <div class="lg:col-span-2 rounded-2xl border border-slate-800 bg-slate-900/80 shadow-2xl shadow-slate-900/60 p-6 space-y-6">
          <div class="flex flex-wrap items-end gap-4">
            <div class="space-y-2">
              <p class="text-sm text-slate-400">Régime</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <button class="regime-btn" data-regime="achat">Achat</button>
                <button class="regime-btn" data-regime="achat_at">Achat + AT</button>
                <button class="regime-btn" data-regime="loc60">Location 5 ans</button>
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm text-slate-400">Remise installation (%)</label>
              <input id="remise-install" type="number" min="0" max="100" class="w-40 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-right" value="0">
            </div>
          </div>

          <div class="flex flex-wrap gap-3 items-center">
            <label class="inline-flex items-center gap-2 text-sm text-slate-300">
              <input id="toggle-selected" type="checkbox" class="accent-sky-400"> Afficher uniquement les quantités &gt; 0
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-300">
              <input id="toggle-hide-empty" type="checkbox" class="accent-sky-400"> Masquer les lignes non chiffrées
            </label>
            <div class="ml-auto flex items-center gap-2">
              <input id="search" type="search" placeholder="Rechercher un produit" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 w-72">
              <button id="export-offer" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow">Exporter l'offre</button>
            </div>
          </div>
        </div>

        <aside class="rounded-2xl border border-slate-800 bg-slate-900/90 shadow-xl shadow-slate-900/50 p-5 space-y-4 lg:sticky lg:top-6">
          <div class="flex items-center justify-between">
            <p class="text-sm text-slate-400">Snapshot</p>
            <p class="text-xs text-slate-500" id="cc-services">Inclut services Call Connect</p>
          </div>
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-slate-300 text-sm">Total mensuel</span>
              <span class="text-xl font-semibold text-white" id="total-mensuel">0,00 €</span>
            </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-300 text-sm">Total achat</span>
            <span class="text-xl font-semibold text-white" id="total-achat">0,00 €</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-300 text-sm">Total installation</span>
            <span class="text-xl font-semibold text-white" id="total-installation">0,00 €</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-slate-300 text-sm">Remises postes/licences (%)</span>
            <span class="text-lg font-semibold text-emerald-400" id="total-remises">0,00 €</span>
          </div>
            <div class="flex items-center justify-between text-sm text-slate-400">
              <span>Lignes actives</span>
              <span id="ligne-comptee">0</span>
            </div>
            <div class="flex items-center justify-between text-sm text-slate-400">
              <span>Masquées</span>
              <span id="ligne-masquee">Masquées : 0</span>
            </div>
            <p class="text-xs text-emerald-400" id="remise-value">Remise installation : 0,00 €</p>
          </div>
        </aside>
      </div>
    </section>

    <section id="product-wrapper" class="space-y-6"></section>
  </main>

<script>
let produits = [];
let quantities = {};
let perItemDiscounts = {};
let regime = "loc60";
let remiseInstall = 0;
let onlySelected = false;
let hideEmpty = false;
let searchTerm = "";
const collapsedFamilies = new Set();

const deviceCategories = new Set([
  "Devices",
  "DECT",
  "DECT Accessoires",
  "Call Connect End Points",
  "Call Connect End Points - DECT"
]);
const achatOnlyCategories = new Set([
  "Headset",
  "Headset Accessoires",
  "UTP Cables",
  "Rack",
  "Installation material",
  "Parlophones",
  "Interface",
  "UPS",
  "Elévateur "
]);
const achatOnlyProducts = new Set([
  "pabx - on site training (2h)"
]);
const hiddenPatterns = [
  "call connect pack",
  "call connect endpoint",
  "call connect endpoints",
  "internet maxi with bizz services",
  "internet maxi fiber with bizz services",
  "fullfiber extended",
  "bizz internet",
  "internet pro+",
  "explore vdsl",
  "explore fiber",
  "call connect site",
  "call connect multi-site",
  "enterprise voice",
  "voip individual number call connect",
  "voip range of 10 numbers call connect",
  "unlimited calls national",
  "closed user group voip call connect",
  "ip-phone t40g",
  "ip-phone t42g",
  "ip-phone t42s",
  "ip-phone t48s",
  "ip phone t58a",
  "wallmount for t42g/s"
];
// Toujours facturés en location quel que soit le régime (licences, CTI, group licences)
const alwaysLocationCategories = new Set([
  "Licences utilisateurs",
  "Voicemail 10 individual Licences",
  "Voicemail for IVR/Group Licences",
  "CTI"
]);
const standardLicenceName = "standard license call connect";
const softphoneLicenceName = "softphone license call connect";
const messagingLicenceName = "messaging license call connect";
const locEligibleCategories = new Set([
  "Devices",
  "DECT",
  "Call Connect End Points",
  "Call Connect End Points - DECT",
  "DECT Accessoires",
  "Licences utilisateurs",
  "Voicemail 10 individual Licences",
  "Voicemail for IVR/Group Licences",
  "CTI",
  "Parlophones",
  "Alert",
  "SLA"
]);
const locEligibleNamePatterns = [
  "switch",
  "poe",
  "router",
  "gateway"
];
// Mapping produit -> famille pour le rendu et pour d'éventuelles futures mises à jour depuis l'export HTML.
// Mettre à jour cette table si de nouvelles catégories apparaissent dans le fichier source.
const familyMap = {
  "Devices": "Endpoints",
  "Call Connect End Points": "Endpoints",
  "DECT": "DECT & Accessoires",
  "Call Connect End Points - DECT": "DECT & Accessoires",
  "DECT Accessoires": "DECT & Accessoires",
  "Headset": "Audio & Casques",
  "Headset Accessoires": "Audio & Casques",
  "Licences utilisateurs": "Licences",
  "Voicemail 10 individual Licences": "Licences",
  "Voicemail for IVR/Group Licences": "Licences",
  "CTI": "Intégrations",
  "Alert": "Alertes",
  "Parlophones": "Parlophones",
  "Installation material": "Infra & Matériel",
  "UTP Cables": "Infra & Matériel",
  "Rack": "Infra & Matériel",
  "UPS": "Infra & Matériel",
  "Elévateur ": "Infra & Matériel",
  "Interface": "Infra & Matériel",
  "SLA": "Services",
  "Service d'Operation": "Services",
  "Multi-site coordinator price PER SITE": "Services"
};

function euros(value) {
  return value.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
}

function isStandardLicence(prod) {
  return prod.Produit.toLowerCase().includes("standard license call connect");
}

function isPoste(prod) {
  return deviceCategories.has(prod.Categorie);
}

function isAchatOnly(prod) {
  return achatOnlyCategories.has(prod.Categorie)
    || achatOnlyProducts.has(prod.Produit.toLowerCase())
    || ((prod.Loc36 || 0) === 0 && (prod.Loc60 || 0) === 0);
}

function isHiddenByName(prod) {
  const name = prod.Produit.toLowerCase();
  return hiddenPatterns.some(p => name.includes(p));
}

function isLocEligible(prod) {
  const name = prod.Produit.toLowerCase();
  if (locEligibleCategories.has(prod.Categorie)) return true;
  if (locEligibleNamePatterns.some(p => name.includes(p))) return true;
  // Switch famille est considérée loc-eligible
  if (getFamily(prod) === "Switch") return true;
  return false;
}

function getProductByNameContains(substr) {
  const target = substr.toLowerCase();
  return produits.find(p => p.Produit.toLowerCase().includes(target));
}

function syncDependentLicences(qtyStd) {
  const soft = getProductByNameContains(softphoneLicenceName);
  const msg = getProductByNameContains(messagingLicenceName);
  [soft, msg].forEach(prod => {
    if (!prod) return;
    quantities[prod.id] = qtyStd;
    const input = document.getElementById(`qty-${prod.id}`);
    if (input) input.value = qtyStd;
  });
}

function slugify(text) {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, "-");
}

function getFamily(prod) {
  const name = prod.Produit.toLowerCase();
  if (name.includes("softphone installation")) return "Licences";
  if (name.includes("switch") || name.includes("poe")) return "Switch";
  if (name.includes("doorphone") || name.includes("portier")) return "Parlophones";

  const mapped = familyMap[prod.Categorie];
  if (mapped) return mapped;
  if (name.includes("w53h") || name.includes("dect")) return "DECT & Accessoires";
  if (name.includes("phone") || name.includes("t4") || name.includes("t5")) return "Endpoints";
  if (name.includes("headset") || name.includes("casque") || name.includes("poly") || name.includes("plantronics")) return "Audio & Casques";
  if (name.includes("voicemail")) return "Licences";
  return "Autres";
}

function categoryIcon(cat) {
  const svg = (path) =>
    `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">${path}</svg>`;
  const icons = {
    "Endpoints": svg('<path d="M4 5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5Zm2 0v9h12V5H6Zm4 13h4a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1Z"/>'),
    "DECT & Accessoires": svg('<path d="M12 3a7 7 0 0 1 7 7c0 2.61-1.4 4.88-3.5 6.12V19a1 1 0 0 1-1 1h-1v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1H9a1 1 0 0 1-1-1v-2.88A6.98 6.98 0 0 1 5 10a7 7 0 0 1 7-7Zm0 2a5 5 0 0 0-5 5c0 1.87 1.02 3.51 2.5 4.39V18h5v-3.61A5.01 5.01 0 0 0 17 10a5 5 0 0 0-5-5Z"/>'),
    "Audio & Casques": svg('<path d="M12 3a7 7 0 0 0-7 7v2a2 2 0 0 0 2 2h1v3a1 1 0 0 0 1 1h3v-3h2v3h3a1 1 0 0 0 1-1v-3h1a2 2 0 0 0 2-2v-2a7 7 0 0 0-7-7Zm-5 7a5 5 0 1 1 10 0v2h-1V9a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1v5H8V9a1 1 0 0 0-1-1H5v2Z"/>'),
    "Switch": svg('<path d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-3v2h2a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2h2v-2H6a2 2 0 0 1-2-2V6Zm2 0v6h12V6H6Zm2 1h2v2H8V7Zm4 0h2v2h-2V7Zm4 0h2v2h-2V7Z"/>'),
    "Licences": svg('<path d="M9 6a3 3 0 1 1 6 0v2a3 3 0 1 1-6 0V6Zm-4 9a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v4H5v-4Zm4 0a2 2 0 0 0-2 2v2h10v-2a2 2 0 0 0-2-2H9Z"/>'),
    "Voicemail": svg('<path d="M7 7a3 3 0 1 1 6 0v1a3 3 0 1 1-6 0V7Zm8 0a2 2 0 1 1 4 0v1a2 2 0 1 1-4 0V7ZM3 7a2 2 0 1 1 4 0v1a2 2 0 1 1-4 0V7Zm-1 8a4 4 0 0 1 4-4h6a4 4 0 0 1 0 6H8a4 4 0 0 1-4-4Zm4-1a2 2 0 0 0-2 2v2h10v-2a2 2 0 0 0-2-2H8Z"/>'),
    "Intégrations": svg('<path d="M7 5a3 3 0 0 1 3-3h4a3 3 0 0 1 0 6h-4a3 3 0 0 1-3-3Zm3-1a1 1 0 1 0 0 2h4a1 1 0 1 0 0-2h-4ZM5 15a3 3 0 0 1 3-3h4a3 3 0 0 1 0 6H8a3 3 0 0 1-3-3Zm3-1a1 1 0 1 0 0 2h4a1 1 0 1 0 0-2H8Z"/>'),
    "Alertes": svg('<path d="M11.1 3.38a1 1 0 0 1 1.8 0l7 14A1 1 0 0 1 19 19H5a1 1 0 0 1-.9-1.62l7-14ZM12 16a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm0-4a1 1 0 0 0 1-1V8a1 1 0 1 0-2 0v3a1 1 0 0 0 1 1Z"/>'),
    "Parlophones": svg('<path d="M8 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1V3Zm2 1v2h4V4h-4Zm0 4v2h4V8h-4Zm0 4v2h4v-2h-4Zm2 4a1 1 0 1 0 0 2h0a1 1 0 0 0 0-2Z"/>'),
    "Infra & Matériel": svg('<path d="M4 6a2 2 0 0 1 2-2h5v3h2V4h3a2 2 0 0 1 2 2v5h-3V9h-2v2h-2V9H9v2H6V6Zm0 6h3v8H6a2 2 0 0 1-2-2v-6Zm5 0h2v8H9v-8Zm4 0h2v8h-2v-8Z"/>'),
    "Services": svg('<path d="M5 5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8.5l-3.25-1.63a1 1 0 0 0-.9 0L12 13l-2.85-1.13a1 1 0 0 0-.9 0L5 13.5V5Zm0 12.2 4.45-2.23L12 15l2.55-.03L19 17.2V19H5v-1.8Z"/>'),
    "Autres": svg('<path d="M12 3 9 9l-6 .5 4.5 4-1.5 6 6-3.5 6 3.5-1.5-6 4.5-4-6-.5-3-6Z"/>')
  };
  return icons[cat] || svg('<path d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6Zm2 0v10h12V6H6Zm2 3h8v2H8V9Zm0 4h5v2H8v-2Z"/>');
}
function computeSubcategory(prod) {
    if (prod.Categorie !== "Autres") return prod.Categorie;
    const name = prod.Produit.toLowerCase();
    if (name.includes("license call connect pack")) return "Packs licences";
    if (name.includes("license call connect")) return "Licences et options";
    if (name.includes("plantronics") || name.includes("poly") || name.includes("headset")) return "Casques / audio";
    if (name.includes("switch") || name.includes("huawei")) return "Réseau / switch";
    if (name.includes("doorphone") || name.includes("portier")) return "Parlophones / portiers";
    if (name.includes("internet") || name.includes("explore") || name.includes("fiber")) return "Connectivité";
    if (name.includes("cabling") || name.includes("patch") || name.includes("vertical cabling")) return "Câblage / câblerie";
    return "Divers Autres";
}
function computeSubcategory(prod) {
  if (prod.Categorie !== "Autres") return prod.Categorie;
  const name = prod.Produit.toLowerCase();
  if (name.includes("license call connect pack")) return "Packs licences";
  if (name.includes("license call connect")) return "Licences et options";
  if (name.includes("plantronics") || name.includes("poly") || name.includes("headset")) return "Casques / audio";
  if (name.includes("switch") || name.includes("huawei")) return "Réseau / switch";
  if (name.includes("doorphone") || name.includes("portier")) return "Parlophones / portiers";
  if (name.includes("internet") || name.includes("explore") || name.includes("fiber")) return "Connectivité";
  if (name.includes("cabling") || name.includes("patch") || name.includes("vertical cabling")) return "Câblage / câblerie";
  return "Divers Autres";
}

function isAlwaysLocation(prod) {
  return alwaysLocationCategories.has(prod.Categorie);
}

function pickLocationPrice(prod, regimeOverride) {
  const r = regimeOverride || regime;
  if (r === "loc60") return prod.Loc60 || prod.Loc36 || 0;
  // pour les régimes achat/achat_at ou les catégories toujours en loc : on prend la loc si dispo (36 sinon 60)
  return prod.Loc36 || prod.Loc60 || 0;
}

function computePrice(prod, regimeOverride) {
  const regimeToUse = regimeOverride || regime;
  const achat = prod.Achat || 0;
  const at = prod.AT || 0;
  const locPrice = pickLocationPrice(prod, regimeToUse);
  const alwaysLocation = isAlwaysLocation(prod);
  const locEligible = isLocEligible(prod);

  let monthly = 0;
  let upfront = 0;
  let monthlyBase = 0;
  let upfrontBase = 0;
  let billing = "upfront"; // "monthly" ou "upfront"
  let fallbackToAchat = false; // vrai si régime loc mais pas de loc => achat

  const isLocRegime = regimeToUse === "loc60";

  if (alwaysLocation) {
    monthlyBase = locPrice;
  } else if (regimeToUse === "achat") {
    if (achat > 0) {
      upfrontBase = achat;
    } else if (locEligible && locPrice > 0) {
      monthlyBase = locPrice;
    }
  } else if (regimeToUse === "achat_at") {
    if (achat > 0) upfrontBase = achat;
    if (at > 0) monthlyBase = at;
    if (!achat && locEligible && locPrice > 0) {
      // Produit non achetable mais louable
      monthlyBase = locPrice;
      upfrontBase = 0;
    }
  } else if (isLocRegime) {
    if (locEligible && locPrice > 0) {
      monthlyBase = locPrice;
    } else {
      // non louable ou pas de tarif loc : on facture l'achat en one-shot
      upfrontBase = achat;
      fallbackToAchat = achat > 0;
    }
  }

  let discount = 0;
  const itemDiscount = perItemDiscounts[prod.id] || 0;
  discount = Math.max(discount, itemDiscount);
  monthly = monthlyBase * (1 - discount / 100);
  upfront = upfrontBase * (1 - discount / 100);
  billing = monthly > 0 ? "monthly" : "upfront";

  return { monthly, upfront, monthlyBase, upfrontBase, discount, billing, fallbackToAchat };
}

function renderGroupedTable() {
  const container = document.getElementById("product-wrapper");
  container.innerHTML = "";
  const searchActive = searchTerm.trim().length > 0;

  const families = {};
  produits.forEach(prod => {
    const fam = getFamily(prod);
    families[fam] = families[fam] || [];
    families[fam].push(prod);
  });

  const famNames = Object.keys(families).sort();
  if (collapsedFamilies.size === 0) famNames.forEach(f => collapsedFamilies.add(f));

  famNames.forEach(fam => {
    const isCollapsed = collapsedFamilies.has(fam) && !searchActive;
    const section = document.createElement("section");
    section.className = "rounded-2xl border border-slate-800 bg-slate-900/60 overflow-hidden shadow-lg shadow-slate-900/50";
    section.dataset.family = fam;
    section.innerHTML = `
      <div class="flex items-center justify-between px-4 py-3 bg-slate-900/80 border-b border-slate-800">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Famille</p>
          <h2 class="text-lg font-semibold text-white flex items-center gap-2">
            <span class="w-5 h-5 inline-flex items-center justify-center text-sky-300">${categoryIcon(fam)}</span>
            <span>${fam}</span>
          </h2>
        </div>
        <button class="toggle-cat text-slate-300 hover:text-white text-xl" aria-label="Basculer famille">${isCollapsed ? "▶" : "▼"}</button>
      </div>
      <div class="cat-body ${isCollapsed ? "hidden" : ""}">
        ${renderFamilyTable(fam, families[fam])}
      </div>
    `;
    container.appendChild(section);

    section.querySelector(".toggle-cat").addEventListener("click", () => {
      if (collapsedFamilies.has(fam)) collapsedFamilies.delete(fam); else collapsedFamilies.add(fam);
      section.querySelector(".cat-body").classList.toggle("hidden");
      section.querySelector(".toggle-cat").innerText = collapsedFamilies.has(fam) ? "▶" : "▼";
    });
  });
  bindQuantityInputs();
  bindDiscountInputs();
}

function renderFamilyTable(family, list) {
  const slug = slugify(family);
  const regimeLabel = (r) => {
    if (r === "achat") return "Achat";
    if (r === "achat_at") return "AT";
    if (r === "loc36") return "Loc36";
    if (r === "loc60") return "Loc60";
    return r;
  };
  const rows = list.map(prod => {
    const qty = quantities[prod.id] || 0;
    const achatOnly = isAchatOnly(prod);
    return `
      <tr id="row-${prod.id}" data-family="${family}" class="${qty > 0 ? "row-active" : ""}">
        <td class="px-4 py-2 align-top col-product">
          <div class="font-medium text-white leading-snug">${prod.Produit}</div>
          <div class="text-xs text-slate-500 flex gap-2 mt-1">
            <span class="tag bg-slate-800 text-slate-200 border border-slate-700">${prod.Categorie}</span>
            ${isPoste(prod) ? '<span class="tag bg-slate-800 text-sky-200 border border-slate-700">Poste</span>' : ""}
            ${isStandardLicence(prod) ? '<span class="tag bg-slate-800 text-amber-200 border border-slate-700">Licence standard</span>' : ""}
          </div>
        </td>
        <td class="px-4 py-2 text-right">
          <div id="prix-${prod.id}" class="font-semibold text-slate-100">-</div>
          <div id="discount-${prod.id}" class="text-xs text-emerald-400"></div>
          <div id="alt-${prod.id}" class="text-[11px] text-slate-500 mt-0.5"></div>
        </td>
        <td class="px-4 py-2 text-right col-discount">
          <input type="number" min="0" max="100" value="${perItemDiscounts[prod.id] ?? ""}" placeholder="0" id="disc-${prod.id}" class="w-20 bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-right" />
        </td>
        <td class="px-4 py-2 text-right col-qte">
          <input type="number" min="0" value="${qty > 0 ? qty : ""}" placeholder="0" id="qty-${prod.id}" class="w-20 bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-right" />
        </td>
        <td class="px-4 py-2 text-right col-total">
          <div id="total-${prod.id}" class="font-semibold text-slate-100">-</div>
        </td>
        <td class="px-4 py-2 text-right col-upfront">
          <div id="upfront-${prod.id}" class="font-semibold text-slate-100">-</div>
        </td>
        <td class="px-4 py-2 text-right col-install">
          <div id="install-${prod.id}" class="font-semibold text-slate-100">-</div>
        </td>
      </tr>
    `;
  }).join("");

  return `
    <div class="overflow-x-auto">
    <table class="w-full text-sm min-w-[1200px]">
      <thead class="bg-slate-900/70 text-slate-300">
        <tr>
          <th class="text-left px-4 py-2 col-product">Produit</th>
          <th class="px-4 py-2 col-price">Prix (${regimeLabel(regime)})</th>
          <th class="px-4 py-2 col-discount">Remise (%)</th>
          <th class="px-4 py-2 col-qte">Qté</th>
          <th class="px-4 py-2 col-total">Total mensuel</th>
          <th class="px-4 py-2 col-upfront">Achat (frais uniques)</th>
          <th class="px-4 py-2 col-install">Installation</th>
        </tr>
      </thead>
      <tbody id="tbody-${slug}" class="divide-y divide-slate-800">
        ${rows}
      </tbody>
    </table>
    </div>
  `;
}
function updateTotals() {
  let totalMensuel = 0;
  let totalInstallBase = 0;
  let totalUpfrontOnly = 0;
  let deviceQty = 0;
  let totalRemises = 0;
  let lignesActives = 0;
  let lignesMasquees = 0;
  const visibleByFamily = {};
  const searchActive = searchTerm.trim().length > 0;
  const activeRows = [];

  produits.forEach(prod => {
    const qtyInput = document.getElementById(`qty-${prod.id}`);
    const row = document.getElementById(`row-${prod.id}`);
    if (!qtyInput || !row) return;
    const qty = parseInt(qtyInput.value || "0");
    quantities[prod.id] = qty;
    const { monthly, upfront, monthlyBase, upfrontBase, discount, billing, fallbackToAchat } = computePrice(prod);
    const installBase = (prod.Install || 0) * qty;
    const unitDisplay = monthly > 0 ? monthly : upfront;
    const totalLine = monthly * qty;
    const upfrontTotal = upfront * qty;
    const installLine = billing === "upfront" ? upfrontTotal + installBase : 0;

    if (isPoste(prod)) deviceQty += qty;
    totalMensuel += totalLine;
    totalUpfrontOnly += upfrontTotal;
    totalInstallBase += billing === "upfront" ? installBase : 0;
    totalRemises += (monthlyBase - monthly) * qty + (upfrontBase - upfront) * qty;
    if (qty > 0) lignesActives += 1;

    const suffix = billing === "monthly" ? "/mois" : "(achat" + (fallbackToAchat ? " - pas de loc possible" : "") + ")";
    document.getElementById(`prix-${prod.id}`).innerText = unitDisplay > 0 ? `${euros(unitDisplay)} ${suffix}` : "Non chiffré";
    document.getElementById(`discount-${prod.id}`).innerText = discount > 0 ? `-${discount}% appliqué` : "";
    const alt = ["achat", "achat_at", "loc60"]
      .map(r => {
        const { monthly: m, upfront: u, billing: b, fallbackToAchat: fb } = computePrice(prod, r);
        const label = r === "achat" ? "Achat" : r === "achat_at" ? "AT" : r === "loc36" ? "Loc36" : "Loc60";
        const isMonthly = b === "monthly";
        const val = isMonthly ? m : u;
        if (!val) return null;
        const tag = r === regime ? " (sélectionné)" : "";
        const mode = isMonthly ? "/mois" : `(achat${fb ? " - pas de loc possible" : ""})`;
        return `${label}: ${euros(val)} ${mode}${tag}`;
      })
      .filter(Boolean)
      .join(" · ");
    const altNode = document.getElementById(`alt-${prod.id}`);
    if (altNode) altNode.innerText = alt;
    document.getElementById(`total-${prod.id}`).innerText = euros(totalLine);
    document.getElementById(`upfront-${prod.id}`).innerText = euros(upfrontTotal);
    document.getElementById(`install-${prod.id}`).innerText = euros(installLine);

    const matchesSearch = prod.Produit.toLowerCase().includes(searchTerm.toLowerCase());
    const visible = matchesSearch && ((!onlySelected || qty > 0 || searchActive) && (!hideEmpty || unitDisplay > 0 || searchActive)) && !isHiddenByName(prod);
    if (!visible) lignesMasquees += 1;
    row.style.display = visible ? "" : "none";
    row.classList.toggle("opacity-50", qty === 0 || unitDisplay === 0);
    row.classList.toggle("row-active", qty > 0);

    if (visible) {
      const fam = row.dataset.family || getFamily(prod);
      visibleByFamily[fam] = (visibleByFamily[fam] || 0) + 1;
    }

    if (qty > 0) {
      activeRows.push({
        prod,
        qty,
        totalLine,
        installLine
      });
    }
  });

  document.querySelectorAll("[data-family]").forEach(section => {
    const fam = section.dataset.family;
    const body = section.querySelector(".cat-body");
    if (!body) return;
    const hasVisible = visibleByFamily[fam] > 0 || (!onlySelected && !hideEmpty);
    section.style.display = hasVisible ? "" : "none";
    if (searchActive && visibleByFamily[fam] > 0) {
      body.classList.remove("hidden");
      const toggle = section.querySelector(".toggle-cat");
      if (toggle) toggle.innerText = "▼";
    } else if (collapsedFamilies.has(fam)) {
      body.classList.add("hidden");
      const toggle = section.querySelector(".toggle-cat");
      if (toggle) toggle.innerText = "▶";
    }
  });

  if (regime === "loc36" || regime === "loc60") {
    totalMensuel += 6.0;
    const devCost = deviceQty * 0.5;
    totalMensuel += devCost;
    document.getElementById("cc-services").innerText = `Start 6,00 € + devices ${devCost > 0 ? euros(devCost) : "-"}`;
  } else {
    document.getElementById("cc-services").innerText = "Pas de frais mensuels supplémentaires";
  }

  const remiseInstallValue = totalInstallBase * (remiseInstall / 100);
  const installNet = totalInstallBase - remiseInstallValue;

  document.getElementById("total-mensuel").innerText = euros(totalMensuel);
  document.getElementById("total-achat").innerText = euros(totalUpfrontOnly);
  document.getElementById("total-installation").innerText = euros(installNet);
  document.getElementById("remise-value").innerText = `Remise installation : ${euros(remiseInstallValue)}`;
  document.getElementById("total-remises").innerText = euros(totalRemises);
  document.getElementById("ligne-comptee").innerText = lignesActives;
  document.getElementById("ligne-masquee").innerText = `Masquées : ${lignesMasquees}`;

  renderActiveSummary(activeRows);
}

function activateButtons() {
  document.querySelectorAll(".regime-btn").forEach(btn => {
    btn.className = "regime-btn px-3 py-2 rounded-lg border text-sm transition " +
      (btn.dataset.regime === regime
        ? "bg-sky-500/20 border-sky-400 text-white"
        : "bg-slate-800 border-slate-700 text-slate-200 hover:border-slate-500");
    btn.onclick = () => {
      regime = btn.dataset.regime;
      activateButtons();
      renderGroupedTable();
      updateTotals();
    };
  });
}

function bindControls() {
  document.getElementById("remise-install").addEventListener("input", (e) => {
    remiseInstall = parseFloat(e.target.value || "0");
    updateTotals();
  });
  document.getElementById("toggle-selected").addEventListener("change", (e) => {
    onlySelected = e.target.checked;
    updateTotals();
  });
  document.getElementById("toggle-hide-empty").addEventListener("change", (e) => {
    hideEmpty = e.target.checked;
    updateTotals();
  });
  document.getElementById("search").addEventListener("input", (e) => {
    searchTerm = e.target.value;
    updateTotals();
  });
  document.getElementById("export-offer").addEventListener("click", exportOffer);
  document.getElementById("export-offer-top").addEventListener("click", exportOffer);
}

function bindQuantityInputs() {
  document.querySelectorAll("input[id^='qty-']").forEach(input => {
    input.addEventListener("input", (e) => {
      const id = e.target.id.replace("qty-", "");
      const qty = parseInt(e.target.value || "0");
      quantities[id] = qty;
      const prod = produits.find(p => String(p.id) === id);
      if (prod && prod.Produit.toLowerCase().includes(standardLicenceName)) {
        syncDependentLicences(qty);
      }
      updateTotals();
    });
  });
}

function bindDiscountInputs() {
  document.querySelectorAll("input[id^='disc-']").forEach(input => {
    input.addEventListener("input", (e) => {
      const id = e.target.id.replace("disc-", "");
      const value = parseFloat(e.target.value || "0");
      perItemDiscounts[id] = isNaN(value) ? 0 : value;
      updateTotals();
    });
  });
}

function renderActiveSummary(activeRows) {
  const wrapper = document.getElementById("offer-summary");
  const list = document.getElementById("offer-list");
  if (!wrapper || !list) return;

  if (!activeRows.length) {
    wrapper.classList.add("hidden");
    list.innerHTML = "";
    return;
  }
  wrapper.classList.remove("hidden");
  list.innerHTML = activeRows
    .map(({ prod, qty, totalLine }) => `
      <div class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-2 flex items-center gap-3 shadow">
        <div class="text-xs text-slate-500">${getFamily(prod)}</div>
        <div class="text-sm text-white font-medium">${prod.Produit}</div>
        <span class="text-xs text-slate-400">x${qty}</span>
        <span class="text-sm font-semibold text-sky-200 ml-auto">${euros(totalLine)}</span>
      </div>
    `)
    .join("");
}

function exportOffer() {
  const rows = produits
    .map(prod => {
      const qty = quantities[prod.id] || 0;
      if (qty <= 0 || isHiddenByName(prod)) return null;
      const { monthly, upfront, discount } = computePrice(prod);
      let totalLine = 0;
      let installLine = 0;
      let achatUnique = 0;
      const installBase = (prod.Install || 0) * qty;

      totalLine = monthly * qty;
      if (upfront > 0) {
        achatUnique = upfront * qty;
        installLine = upfront * qty + installBase;
      }

      const unit = monthly > 0 ? monthly : upfront;

      return { ...prod, qty, price: unit, discount, totalLine, installLine, achatUnique };
    })
    .filter(Boolean);

  if (!rows.length) {
    alert("Aucune ligne active à exporter.");
    return;
  }

  const byFam = {};
  let deviceQty = 0;
  rows.forEach(r => {
    const fam = getFamily(r);
    byFam[fam] = byFam[fam] || [];
    byFam[fam].push(r);
    if (isPoste(r)) deviceQty += r.qty;
  });

  let html = `
    <html><head><meta charset="utf-8"><title>Offre Call Connect</title>
    <style>
      body { font-family: Arial, sans-serif; color: #0f172a; padding: 24px; }
      h1 { margin: 0 0 12px 0; }
      h2 { margin: 16px 0 8px 0; }
      table { border-collapse: collapse; width: 100%; margin-bottom: 16px; }
      th, td { border: 1px solid #cbd5e1; padding: 8px; font-size: 12px; }
      th { background: #e2e8f0; text-align: left; }
      tbody tr:nth-child(odd) { background: #f8fafc; }
      tfoot td { font-weight: bold; }
      .badge { display:inline-block; padding:2px 6px; border-radius:10px; background:#e2e8f0; margin-left:6px; font-size:11px;}
    </style></head><body>
    <h1>Offre Call Connect</h1>
    <p>Régime : ${regime} | Remise installation ${remiseInstall}%</p>
  `;

  Object.keys(byFam).sort().forEach(fam => {
    html += `<h2>${fam}</h2><table><thead><tr>
      <th>Produit</th><th>Catégorie</th><th>Prix unitaire</th><th>Remise</th><th>Qté</th><th>Total mensuel</th><th>Installation</th><th>Frais achat</th>
    </tr></thead><tbody>`;
    byFam[fam].forEach(r => {
      html += `<tr>
        <td>${r.Produit}</td>
        <td>${r.Categorie}</td>
        <td style="text-align:right;">${euros(r.price)}</td>
        <td style="text-align:right;">${r.discount ? "-" + r.discount + "%" : "-"}</td>
        <td style="text-align:right;">${r.qty}</td>
        <td style="text-align:right;">${euros(r.totalLine)}</td>
        <td style="text-align:right;">${euros(r.installLine)}</td>
        <td style="text-align:right;">${euros(r.achatUnique || 0)}</td>
      </tr>`;
    });
    html += "</tbody></table>";
  });

  let totalMensuel = rows.reduce((s, r) => s + r.totalLine, 0);
  if (regime === "loc36" || regime === "loc60") {
    totalMensuel += 6 + deviceQty * 0.5;
  }
  const totalInstall = rows.reduce((s, r) => s + r.installLine, 0);
  const totalAchatUnique = rows.reduce((s, r) => s + (r.achatUnique || 0), 0);
  const remiseInstallValue = totalInstall * (remiseInstall / 100);
  const installNet = totalInstall - remiseInstallValue;
  const totalFraisUniquesNet = installNet + totalAchatUnique;

  html += `<table><tfoot>
    <tr><td>Total mensuel</td><td style="text-align:right;">${euros(totalMensuel)}</td></tr>
    <tr><td>Frais d'installation</td><td style="text-align:right;">${euros(installNet)} (remise ${euros(remiseInstallValue)})</td></tr>
    <tr><td>Frais achat uniques</td><td style="text-align:right;">${euros(totalAchatUnique)}</td></tr>
    <tr><td>Total frais uniques</td><td style="text-align:right;">${euros(totalFraisUniquesNet)}</td></tr>
  </tfoot></table>`;

  html += "</body></html>";

  const win = window.open("", "_blank");
  if (!win) {
    alert("Pop-up bloqué : autorisez l'ouverture pour exporter.");
    return;
  }
  win.document.write(html);
  win.document.close();
}

function loadData() {
  fetch("./data/products.json")
    .then(res => res.json())
    .then(data => {
      produits = data.map((p, idx) => ({
        ...p,
        id: idx,
        // harmonise numeric fields
        Achat: Number(p.Achat) || 0,
        AT: Number(p.AT) || 0,
        Loc36: Number(p.Loc36) || 0,
        Loc60: Number(p.Loc60) || 0,
        Install: Number(p.Install) || 0
      }));
      document.getElementById("sync-date").innerText = new Date().toLocaleString("fr-FR");
      document.getElementById("config").classList.remove("hidden");
      renderGroupedTable();
      activateButtons();
      bindControls();
      updateTotals();
    })
    .catch(err => {
      console.error(err);
      alert("Erreur lors du chargement de la base produits : " + err.message);
    });
}

document.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
