<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulateur Call Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --accent: #0ea5e9;
      --accent-strong: #06b6d4;
    }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .tag { font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 999px; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <header class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-8 flex flex-col gap-3">
      <div class="flex items-center gap-3">
        <span class="tag bg-slate-800 text-sky-200 border border-slate-700">PBX vérifié</span>
        <span class="tag bg-emerald-900/60 text-emerald-100 border border-emerald-800">Export prêt Netlify</span>
      </div>
      <div class="flex flex-wrap items-end gap-4">
        <div>
          <h1 class="text-3xl font-bold text-white">Simulateur Call Connect</h1>
          <p class="text-slate-300">Base prix consolidée PBX + Excel, régimes achat / achat+AT / location, remises automatiques.</p>
        </div>
        <div class="ml-auto text-right space-y-1">
          <p class="text-slate-400 text-sm">Dernière synchro</p>
          <p class="text-xl font-semibold text-white" id="sync-date">-</p>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pb-12 space-y-8">
    <section class="relative overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/80 shadow-2xl shadow-slate-900/60">
      <video autoplay loop muted playsinline class="w-full h-72 object-cover opacity-70">
        <source src="https://www.webex.com/content/dam/wbx/us/images/rebrand/hero-videos/webex_device_landing_hero.mp4" type="video/mp4">
      </video>
      <div class="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/70 to-slate-900/30"></div>
      <div class="absolute inset-0 flex flex-col justify-center px-8 py-6 space-y-3">
        <p class="tag bg-slate-800 text-sky-200 border border-slate-700 w-fit">Vue simulateur</p>
        <h2 class="text-2xl font-bold text-white">Configurez, appliquez les remises, exportez</h2>
        <p class="text-slate-300 max-w-3xl">Base prix synchronisée avec PBX + Excel, régimes achat / achat + AT / location, filtres de visibilité et ventilation des remises.</p>
      </div>
    </section>

    <section id="config" class="hidden -mt-8 relative z-10">
      <div class="grid lg:grid-cols-3 gap-6 items-start">
        <div class="lg:col-span-2 rounded-2xl border border-slate-800 bg-slate-900/80 shadow-2xl shadow-slate-900/60 p-6 space-y-6">
          <div class="flex flex-wrap items-end gap-4">
            <div class="space-y-2">
              <p class="text-sm text-slate-400">Régime</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <button class="regime-btn" data-regime="achat">Achat</button>
                <button class="regime-btn" data-regime="achat_at">Achat + AT</button>
                <button class="regime-btn" data-regime="loc36">Location 36 mois</button>
                <button class="regime-btn" data-regime="loc60">Location 60 mois</button>
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm text-slate-400">Remise postes</label>
              <input id="remise-postes" type="number" min="0" max="100" class="w-40 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-right" value="0">
            </div>
            <div class="space-y-2">
              <label class="text-sm text-slate-400">Remise licences standard</label>
              <input id="remise-licences" type="number" min="0" max="100" class="w-52 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-right" value="0">
            </div>
            <div class="space-y-2">
              <label class="text-sm text-slate-400">Remise installation</label>
              <input id="remise-install" type="number" min="0" max="100" class="w-40 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-right" value="0">
            </div>
          </div>

          <div class="flex flex-wrap gap-3 items-center">
            <label class="inline-flex items-center gap-2 text-sm text-slate-300">
              <input id="toggle-selected" type="checkbox" class="accent-sky-400"> Afficher uniquement les quantités &gt; 0
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-300">
              <input id="toggle-hide-empty" type="checkbox" class="accent-sky-400"> Masquer les lignes non chiffrées
            </label>
            <div class="ml-auto flex items-center gap-2">
              <input id="search" type="search" placeholder="Rechercher un produit" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 w-72">
              <button id="export-offer" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow">Exporter l'offre</button>
            </div>
          </div>
        </div>

        <aside class="rounded-2xl border border-slate-800 bg-slate-900/90 shadow-xl shadow-slate-900/50 p-5 space-y-4 lg:sticky lg:top-6">
          <div class="flex items-center justify-between">
            <p class="text-sm text-slate-400">Snapshot</p>
            <p class="text-xs text-slate-500" id="cc-services">Inclut services Call Connect</p>
          </div>
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-slate-300 text-sm">Total mensuel</span>
              <span class="text-xl font-semibold text-white" id="total-mensuel">0,00 €</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-slate-300 text-sm">Total installation</span>
              <span class="text-xl font-semibold text-white" id="total-installation">0,00 €</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-slate-300 text-sm">Remises postes/licences</span>
              <span class="text-lg font-semibold text-emerald-400" id="total-remises">0,00 €</span>
            </div>
            <div class="flex items-center justify-between text-sm text-slate-400">
              <span>Lignes actives</span>
              <span id="ligne-comptee">0</span>
            </div>
            <div class="flex items-center justify-between text-sm text-slate-400">
              <span>Masquées</span>
              <span id="ligne-masquee">Masquées : 0</span>
            </div>
            <p class="text-xs text-emerald-400" id="remise-value">Remise installation : 0,00 €</p>
          </div>
        </aside>
      </div>
    </section>

    <section id="product-wrapper" class="space-y-6"></section>
  </main>

<script>
let produits = [];
let quantities = {};
let regime = "loc36";
let remiseInstall = 0;
let remisePostes = 0;
let remiseLicences = 0;
let onlySelected = false;
let hideEmpty = false;
let searchTerm = "";
const collapsedCategories = new Set();

const deviceCategories = new Set([
  "Devices",
  "DECT",
  "DECT Accessoires",
  "Call Connect End Points",
  "Call Connect End Points - DECT"
]);
const achatOnlyCategories = new Set([
  "Headset",
  "Headset Accessoires",
  "UTP Cables",
  "Rack",
  "Installation material",
  "Parlophones",
  "Interface",
  "UPS",
  "Elévateur "
]);

function euros(value) {
  return value.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
}

function isStandardLicence(prod) {
  return prod.Produit.toLowerCase().includes("standard license call connect");
}

function isPoste(prod) {
  return deviceCategories.has(prod.Categorie);
}

function slugify(text) {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, "-");
}

function computeSubcategory(prod) {
  if (prod.Categorie !== "Autres") return prod.Categorie;
  const name = prod.Produit.toLowerCase();
  if (name.includes("license call connect pack")) return "Packs licences";
  if (name.includes("license call connect")) return "Licences et options";
  if (name.includes("plantronics") || name.includes("poly") || name.includes("headset")) return "Casques / audio";
  if (name.includes("switch") || name.includes("huawei")) return "Réseau / switch";
  if (name.includes("doorphone") || name.includes("portier")) return "Parlophones / portiers";
  if (name.includes("internet") || name.includes("explore") || name.includes("fiber")) return "Connectivité";
  if (name.includes("cabling") || name.includes("patch") || name.includes("vertical cabling")) return "Câblage / câblerie";
  return "Divers Autres";
}

function computePrice(prod) {
  let base = 0;
  const achatAT = (prod.Achat || 0) + (prod.AT || 0);
  const achatOnly = achatOnlyCategories.has(prod.Categorie);

  if (achatOnly || regime === "achat" || regime === "achat_at") {
    base = achatAT || prod.Loc36 || prod.Loc60 || prod.Achat || prod.AT;
  } else if (regime === "loc36") {
    base = prod.Loc36 && prod.Loc36 > 0 ? prod.Loc36 : achatAT;
  } else {
    base = prod.Loc60 && prod.Loc60 > 0 ? prod.Loc60 : achatAT;
  }

  let discount = 0;
  if (isPoste(prod)) discount = Math.max(discount, remisePostes);
  if (isStandardLicence(prod)) discount = Math.max(discount, remiseLicences);
  const price = base * (1 - discount / 100);
  return { price, base, discount };
}

function renderGroupedTable() {
  const container = document.getElementById("product-wrapper");
  container.innerHTML = "";
  const categories = [...new Set(produits.map(p => p.Categorie))].sort();

  categories.forEach(cat => {
    const section = document.createElement("section");
    section.className = "rounded-2xl border border-slate-800 bg-slate-900/60 overflow-hidden shadow-lg shadow-slate-900/50";
    section.dataset.cat = cat;
    section.innerHTML = `
      <div class="flex items-center justify-between px-4 py-3 bg-slate-900/80 border-b border-slate-800">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Catégorie</p>
          <h2 class="text-lg font-semibold text-white">${cat}</h2>
        </div>
        <button class="toggle-cat text-slate-300 hover:text-white text-xl" aria-label="Basculer catégorie">${collapsedCategories.has(cat) ? "▶" : "▼"}</button>
      </div>
      <div class="cat-body ${collapsedCategories.has(cat) ? "hidden" : ""}">
        ${
          cat === "Autres"
            ? renderAutres(produits.filter(p => p.Categorie === cat))
            : renderTable(cat, produits.filter(p => p.Categorie === cat))
        }
      </div>
    `;
    container.appendChild(section);

    section.querySelector(".toggle-cat").addEventListener("click", () => {
      if (collapsedCategories.has(cat)) {
        collapsedCategories.delete(cat);
      } else {
        collapsedCategories.add(cat);
      }
      section.querySelector(".cat-body").classList.toggle("hidden");
      section.querySelector(".toggle-cat").innerText = collapsedCategories.has(cat) ? "▶" : "▼";
    });
  });
  bindQuantityInputs();
}

function renderTable(cat, list, mainCat = cat) {
  const slug = slugify(cat);
  const rows = list.map(prod => {
    const qty = quantities[prod.id] || 0;
    return `
      <tr id="row-${prod.id}" data-maincat="${mainCat}" data-subcat="${cat}" class="${qty > 0 ? "bg-slate-900/50" : ""}">
        <td class="px-4 py-2 align-top">
          <div class="font-medium text-white">${prod.Produit}</div>
          <div class="text-xs text-slate-500 flex gap-2 mt-1">
            ${isPoste(prod) ? '<span class="tag bg-slate-800 text-sky-200 border border-slate-700">Poste</span>' : ""}
            ${isStandardLicence(prod) ? '<span class="tag bg-slate-800 text-amber-200 border border-slate-700">Licence standard</span>' : ""}
          </div>
        </td>
        <td class="px-4 py-2 text-right">
          <div id="prix-${prod.id}" class="font-semibold text-slate-100">-</div>
          <div id="discount-${prod.id}" class="text-xs text-emerald-400"></div>
        </td>
        <td class="px-4 py-2 text-right">
          <input type="number" min="0" value="${qty}" id="qty-${prod.id}" class="w-20 bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-right" />
        </td>
        <td class="px-4 py-2 text-right">
          <div id="total-${prod.id}" class="font-semibold text-slate-100">-</div>
        </td>
        <td class="px-4 py-2 text-right">
          <div id="install-${prod.id}" class="font-semibold text-slate-100">-</div>
        </td>
      </tr>
    `;
  }).join("");

  // return full table markup
  const markup = `
    <table class="w-full text-sm">
      <thead class="bg-slate-900/70 text-slate-300">
        <tr>
          <th class="text-left px-4 py-2">Produit</th>
          <th class="text-right px-4 py-2">Prix (${regime})</th>
          <th class="text-right px-4 py-2">Qté</th>
          <th class="text-right px-4 py-2">Total mensuel</th>
          <th class="text-right px-4 py-2">Installation</th>
        </tr>
      </thead>
      <tbody id="tbody-${slug}" class="divide-y divide-slate-800">
        ${rows}
      </tbody>
    </table>
  `;
  return markup;
}

function renderAutres(list) {
  const grouped = {};
  list.forEach(prod => {
    const sub = computeSubcategory(prod);
    grouped[sub] = grouped[sub] || [];
    grouped[sub].push(prod);
  });
  return Object.keys(grouped).sort().map(sub => {
    return `
      <div class="border-t border-slate-800">
        <div class="px-4 py-3 bg-slate-900/70">
          <p class="text-xs uppercase tracking-wide text-slate-500">Sous-catégorie</p>
          <h3 class="text-md font-semibold text-white">${sub}</h3>
        </div>
        ${renderTable(sub, grouped[sub], "Autres")}
      </div>
    `;
  }).join("");
}

function bindQuantityInputs() {
  document.querySelectorAll("input[id^='qty-']").forEach(input => {
    input.addEventListener("input", (e) => {
      const id = e.target.id.replace("qty-", "");
      quantities[id] = parseInt(e.target.value || "0");
      updateTotals();
    });
  });
}

function exportOffer() {
  const rows = produits
    .map(prod => {
      const qty = quantities[prod.id] || 0;
      if (qty <= 0) return null;
      const { price, discount } = computePrice(prod);
      const totalLine = price * qty;
      const installLine = (prod.Install || 0) * qty;
      return { ...prod, qty, price, discount, totalLine, installLine };
    })
    .filter(Boolean);

  if (!rows.length) {
    alert("Aucune ligne active à exporter.");
    return;
  }

  const byCat = {};
  rows.forEach(r => {
    const cat = r.Categorie || "Autres";
    byCat[cat] = byCat[cat] || [];
    byCat[cat].push(r);
  });

  let html = `
    <html><head><meta charset="utf-8"><title>Offre Call Connect</title>
    <style>
      body { font-family: Arial, sans-serif; color: #0f172a; padding: 24px; }
      h1 { margin: 0 0 12px 0; }
      h2 { margin: 16px 0 8px 0; }
      table { border-collapse: collapse; width: 100%; margin-bottom: 16px; }
      th, td { border: 1px solid #cbd5e1; padding: 8px; font-size: 12px; }
      th { background: #e2e8f0; text-align: left; }
      tfoot td { font-weight: bold; }
    </style></head><body>
    <h1>Offre Call Connect</h1>
    <p>Régime : ${regime} | Remise postes ${remisePostes}% | Remise licences ${remiseLicences}% | Remise installation ${remiseInstall}%</p>
  `;

  Object.keys(byCat).sort().forEach(cat => {
    html += `<h2>${cat}</h2><table><thead><tr>
      <th>Produit</th><th>Prix unitaire</th><th>Remise</th><th>Qté</th><th>Total mensuel</th><th>Installation</th>
    </tr></thead><tbody>`;
    byCat[cat].forEach(r => {
      html += `<tr>
        <td>${r.Produit}</td>
        <td style="text-align:right;">${euros(r.price)}</td>
        <td style="text-align:right;">${r.discount ? "-" + r.discount + "%" : "-"}</td>
        <td style="text-align:right;">${r.qty}</td>
        <td style="text-align:right;">${euros(r.totalLine)}</td>
        <td style="text-align:right;">${euros(r.installLine)}</td>
      </tr>`;
    });
    html += "</tbody></table>";
  });

  const totalMensuel = rows.reduce((s, r) => s + r.totalLine, 0) + ((regime === "loc36" || regime === "loc60") ? 6 + (rows.reduce((s, r) => s + (isPoste(r) ? r.qty : 0), 0) * 0.5) : 0);
  const totalInstall = rows.reduce((s, r) => s + r.installLine, 0);
  const remiseInstallValue = totalInstall * (remiseInstall / 100);
  const installNet = totalInstall - remiseInstallValue;

  html += `<table><tfoot>
    <tr><td>Total mensuel</td><td style="text-align:right;">${euros(totalMensuel)}</td></tr>
    <tr><td>Total installation</td><td style="text-align:right;">${euros(installNet)} (remise ${euros(remiseInstallValue)})</td></tr>
  </tfoot></table>`;

  html += "</body></html>";

  const win = window.open("", "_blank");
  if (!win) {
    alert("Pop-up bloqué : autorisez l'ouverture pour exporter.");
    return;
  }
  win.document.write(html);
  win.document.close();
}

function updateTotals() {
  let totalMensuel = 0;
  let totalInstall = 0;
  let deviceQty = 0;
  let totalRemises = 0;
  let lignesActives = 0;
  let lignesMasquees = 0;
  const visibleByCat = {};
  const searchActive = searchTerm.trim().length > 0;

  produits.forEach(prod => {
    const qtyInput = document.getElementById(`qty-${prod.id}`);
    const row = document.getElementById(`row-${prod.id}`);
    if (!qtyInput || !row) return;
    const qty = parseInt(qtyInput.value || "0");
    quantities[prod.id] = qty;
    const { price, base, discount } = computePrice(prod);
    const totalLine = price * qty;
    const installLine = (prod.Install || 0) * qty;

    if (isPoste(prod)) deviceQty += qty;
    totalMensuel += totalLine;
    totalInstall += installLine;
    totalRemises += (base - price) * qty;
    if (qty > 0) lignesActives += 1;

    document.getElementById(`prix-${prod.id}`).innerText = price > 0 ? euros(price) : "Non chiffré";
    document.getElementById(`discount-${prod.id}`).innerText = discount > 0 ? `-${discount}% appliqué` : "";
    document.getElementById(`total-${prod.id}`).innerText = euros(totalLine);
    document.getElementById(`install-${prod.id}`).innerText = euros(installLine);

    const matchesSearch = prod.Produit.toLowerCase().includes(searchTerm.toLowerCase());
    const visible = matchesSearch && ((!onlySelected || qty > 0 || searchActive) && (!hideEmpty || price > 0 || searchActive));
    if (!visible) lignesMasquees += 1;
    row.style.display = visible ? "" : "none";
    row.classList.toggle("opacity-50", qty === 0 || price === 0);

    if (visible) {
      const main = row.dataset.maincat || prod.Categorie;
      visibleByCat[main] = (visibleByCat[main] || 0) + 1;
    }
  });

  document.querySelectorAll("[data-cat]").forEach(section => {
    const cat = section.dataset.cat;
    const body = section.querySelector(".cat-body");
    if (!body) return;
    const hasVisible = visibleByCat[cat] > 0 || (!onlySelected && !hideEmpty);
    section.style.display = hasVisible ? "" : "none";
  });

  if (regime === "loc36" || regime === "loc60") {
    totalMensuel += 6.0;
    const devCost = deviceQty * 0.5;
    totalMensuel += devCost;
    document.getElementById("cc-services").innerText = `Start 6,00 € + devices ${devCost > 0 ? euros(devCost) : "-"}`;
  } else {
    document.getElementById("cc-services").innerText = "Pas de frais mensuels supplémentaires";
  }

  const remiseInstallValue = totalInstall * (remiseInstall / 100);
  const installNet = totalInstall - remiseInstallValue;

  document.getElementById("total-mensuel").innerText = euros(totalMensuel);
  document.getElementById("total-installation").innerText = euros(installNet);
  document.getElementById("remise-value").innerText = `Remise installation : ${euros(remiseInstallValue)}`;
  document.getElementById("total-remises").innerText = euros(totalRemises);
  document.getElementById("ligne-comptee").innerText = lignesActives;
  document.getElementById("ligne-masquee").innerText = `Masquées : ${lignesMasquees}`;
}

function activateButtons() {
  document.querySelectorAll(".regime-btn").forEach(btn => {
    btn.className = "regime-btn px-3 py-2 rounded-lg border text-sm transition " +
      (btn.dataset.regime === regime
        ? "bg-sky-500/20 border-sky-400 text-white"
        : "bg-slate-800 border-slate-700 text-slate-200 hover:border-slate-500");
    btn.onclick = () => {
      regime = btn.dataset.regime;
      activateButtons();
      renderGroupedTable();
      updateTotals();
    };
  });
}

function bindControls() {
  document.getElementById("remise-install").addEventListener("input", (e) => {
    remiseInstall = parseFloat(e.target.value || "0");
    updateTotals();
  });
  document.getElementById("remise-postes").addEventListener("input", (e) => {
    remisePostes = parseFloat(e.target.value || "0");
    updateTotals();
  });
  document.getElementById("remise-licences").addEventListener("input", (e) => {
    remiseLicences = parseFloat(e.target.value || "0");
    updateTotals();
  });
  document.getElementById("toggle-selected").addEventListener("change", (e) => {
    onlySelected = e.target.checked;
    updateTotals();
  });
  document.getElementById("toggle-hide-empty").addEventListener("change", (e) => {
    hideEmpty = e.target.checked;
    updateTotals();
  });
  document.getElementById("search").addEventListener("input", (e) => {
    searchTerm = e.target.value;
    updateTotals();
  });
  document.getElementById("export-offer").addEventListener("click", exportOffer);
}

function loadData() {
  fetch("./data/products.json")
    .then(res => res.json())
    .then(data => {
      produits = data.map((p, idx) => ({
        ...p,
        id: idx,
        // harmonise numeric fields
        Achat: Number(p.Achat) || 0,
        AT: Number(p.AT) || 0,
        Loc36: Number(p.Loc36) || 0,
        Loc60: Number(p.Loc60) || 0,
        Install: Number(p.Install) || 0
      }));
      document.getElementById("sync-date").innerText = new Date().toLocaleString("fr-FR");
      document.getElementById("config").classList.remove("hidden");
      renderGroupedTable();
      activateButtons();
      bindControls();
      updateTotals();
    })
    .catch(err => {
      console.error(err);
      alert("Erreur lors du chargement de la base produits : " + err.message);
    });
}

document.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
